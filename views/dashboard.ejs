<%- include("partials/header") %>

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold">Civic Performance Dashboard</h3>
      <small class="text-muted">Transparency · Accountability · Impact</small>
    </div>
    <div>
      <button class="btn btn-outline-primary btn-sm">Refresh Data</button>
    </div>
  </div>

  <!-- Authority vs Individuals Tabs -->
  <ul class="nav nav-pills mb-3" id="dashTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="auth-tab" data-bs-toggle="pill" data-bs-target="#auth" type="button" role="tab">Authorities</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="ind-tab" data-bs-toggle="pill" data-bs-target="#ind" type="button" role="tab">Individuals / Contractors</button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- AUTHORITIES DASHBOARD -->
    <div class="tab-pane fade show active" id="auth" role="tabpanel">
      <div class="row g-3 mb-3">
        <!-- KPIs -->
        <div class="col-md-3">
          <div class="card p-3 shadow-sm">
            <h6>Total Issues</h6>
            <div class="display-6 fw-bold" id="auth_total">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3 shadow-sm">
            <h6>Resolved</h6>
            <div class="display-6 fw-bold text-success" id="auth_resolved">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3 shadow-sm">
            <h6>Pending</h6>
            <div class="display-6 fw-bold text-warning" id="auth_pending">--</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3 shadow-sm">
            <h6>Avg Resolution (days)</h6>
            <div class="display-6 fw-bold text-info" id="auth_avg">--</div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <!-- Overall Score -->
        <div class="col-lg-4">
          <div class="card shadow-sm text-center p-3 h-100">
            <h6>Authority Credibility Score</h6>
            <div class="display-1 fw-bold my-2" id="auth_score">--</div>
            <canvas id="auth_doughnut" style="max-width:220px; margin:auto;"></canvas>
            <small class="text-muted d-block mt-2">Based on KPIs + citizen feedback</small>
          </div>
        </div>

        <!-- Department Performance -->
        <div class="col-lg-8">
          <div class="card shadow-sm p-3 h-100">
            <h6>Department Rankings</h6>
            <canvas id="auth_bar" style="height:280px;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- INDIVIDUALS DASHBOARD -->
    <div class="tab-pane fade" id="ind" role="tabpanel">
      <div class="row g-3 mb-3">
        <!-- Top Stats -->
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Total Contractors</h6>
            <div class="display-6 fw-bold" id="ind_total">--</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Avg Credibility Score</h6>
            <div class="display-6 fw-bold text-primary" id="ind_avgscore">--</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3 shadow-sm">
            <h6>Top Performer</h6>
            <div class="fw-bold text-success" id="ind_top">--</div>
          </div>
        </div>
      </div>

      <div class="row g-3">
        <!-- Top Contractors -->
        <div class="col-lg-6">
          <div class="card shadow-sm p-3 h-100">
            <h6>Contractor Rankings</h6>
            <table class="table table-sm table-hover align-middle">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Score</th>
                  <th>Projects</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="ind_table">
                <!-- dynamic -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Leaderboard -->
        <div class="col-lg-6">
          <div class="card shadow-sm p-3 h-100">
            <h6>Leaderboard</h6>
            <canvas id="ind_bar" style="height:280px;"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- Mock Data ---
  const departments = [
    { name: 'Water', score: 82, pending: 450 },
    { name: 'Roads', score: 68, pending: 980 },
    { name: 'Sanitation', score: 74, pending: 620 },
    { name: 'Electricity', score: 59, pending: 1100 },
    { name: 'Health', score: 90, pending: 120 },
    { name: 'Education', score: 78, pending: 210 }
  ];
  const contractors = [
    { name: 'M. Sharma & Co.', score: 91, projects: 24, status: 'Active' },
    { name: 'Singh Infra', score: 77, projects: 18, status: 'On Track' },
    { name: 'Patel Builders', score: 65, projects: 10, status: 'Delayed' },
    { name: 'Rao Constructions', score: 83, projects: 14, status: 'Active' }
  ];

  // --- Render Functions ---
  function renderAuthorities() {
    document.getElementById('auth_total').textContent = 3480;
    document.getElementById('auth_resolved').textContent = 2500;
    document.getElementById('auth_pending').textContent = 980;
    document.getElementById('auth_avg').textContent = '6.4';
    const score = Math.round(departments.reduce((s,d)=>s+d.score,0)/departments.length);
    document.getElementById('auth_score').textContent = score;

    // Bar
    new Chart(document.getElementById('auth_bar'), {
      type: 'bar',
      data: { labels: departments.map(d=>d.name),
        datasets: [{ data: departments.map(d=>d.score), backgroundColor: '#0d6efd' }] },
      options: { plugins:{legend:{display:false}}, scales:{y:{max:100,beginAtZero:true}} }
    });

    // Doughnut
    new Chart(document.getElementById('auth_doughnut'), {
      type:'doughnut',
      data:{ labels:['Score','Remaining'], datasets:[{ data:[score,100-score], backgroundColor:['#198754','#e9ecef']}] },
      options:{ cutout:'70%', plugins:{legend:{display:false}} }
    });
  }

  function renderIndividuals() {
    document.getElementById('ind_total').textContent = contractors.length;
    const avg = Math.round(contractors.reduce((s,c)=>s+c.score,0)/contractors.length);
    document.getElementById('ind_avgscore').textContent = avg;
    document.getElementById('ind_top').textContent = contractors[0].name;

    const tbody = document.getElementById('ind_table');
    tbody.innerHTML='';
    contractors.forEach(c=>{
      let badge = c.score>=80?'bg-success':c.score>=65?'bg-warning':'bg-danger';
      tbody.innerHTML += `
        <tr>
          <td>${c.name}</td>
          <td><span class="badge ${badge}">${c.score}</span></td>
          <td>${c.projects}</td>
          <td>${c.status}</td>
        </tr>`;
    });

    new Chart(document.getElementById('ind_bar'), {
      type:'bar',
      data:{ labels:contractors.map(c=>c.name), datasets:[{ data:contractors.map(c=>c.score), backgroundColor:'#6610f2' }] },
      options:{ plugins:{legend:{display:false}}, scales:{y:{max:100,beginAtZero:true}} }
    });
  }

  renderAuthorities();
  renderIndividuals();
</script>

<%- include("partials/footer") %>
